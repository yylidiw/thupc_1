{{ self.title() }}

作者，版权声明等

## 题目简述

$n$ 个球排成一双端队列，从左到右第 $i$ 个球颜色 $c_i$，每次从两端中的任一端取一个球。

若该球和一个初始为空的栈的栈顶球颜色相同则弹出栈顶，否则将这个球压入栈中。重复上述过程 $n$ 次。

求一种取法，使在最终栈中元素数量最小的前提下，最小化任意时刻栈中元素数量。

## solution

显然考虑dp，例如设 $F(l,r)$ 表示仅考虑编号在 $[l,r]$ 的球的答案。

第一次取必然取 $c_l$ 或者 $c_r$，不妨设是 $c_l$（取 $c_r$ 的讨论是对称的）。

有两种情况：

1）$c_l$ 之后不会被匹配从而消失，这时候把它堪称一块烂石头忽略就可以了，直接从 $F(l+1,r)$ 转移过来。

2）$c_l$ 和之后某个 $c_i=c_l,\left(l<i\le r\right)$ 匹配然后消失掉。要做到这一点，必然是以下两种情况之一：

​	a）把 $[l+1,i-1]$ 和 $[j,r],(i<j\le r+1)$ 的球拿出来之后，拿出了 $c_i$（即从左边摸到 $c_i$），然后变成 $[i+1,j-1]$ 的问题。这要求只从左边取 $[l+1,i-1]$ 的球并且只从右边取 $[j,r]$ 的球，存在一种全部消除的方法，并且全消的方案越优越好（即全消的过程中，栈中最大的元素个数最小，记作 $G(l+1,i-1,j,r)$）。若能全消，那么 $F(l,r)$ 会从 $G(l+1,i-1,j,r)$ 和 $F(i+1,j-1)$ 转移过来。

​	b）从右边摸到 $c_i$，和a）类似。

因此问题转化为求 $G(l_1,r_1,l_2,r_2)$。当 $l_1>r_1$ 时，情况是固定的，模拟即可。$l_2>r_2$ 同理。

考虑 $l_1\le r_1,l_2\le r_2$ 的情形。类似的，假设第一个取的是 $c_{l_1}$（取 $c_{r_2}$ 的情况是对称的）。

这时由于需要全消，所以 $c_{l_1}$ 必然会和某个 $c_i=c_{l_1}$ 匹配消失，分为 $i\in[l_1+1,r_1]$ 或者 $i\in[l_2,r_2]$ 这两种情况类似地讨论即可。例如，若 $i\in[l_1+1,r_1]$，那么 $c_i$ 必然是从左边摸到的。此时 $G(l_1,r_1,l_2,r_2)$ 会从 $G(l_1+1,i-1,j,r_2)$ 和 $G(i+1,r_1,l_2,j-1)$ 转移过来（$l_2\le j\le r_2+1$）。另一种情况类似。

这样就解决了这个问题，理论复杂度 $\mathrm{O}\left(n^6\right)$，但是实际上常数极小（比如在 $G$ 的计算中，总有 $l_1\le r_1<l_2\le r_2;\ i,j\in[l_1,r_1]\bigcup[l_2,r_2]$）；除此之外，在计算 $G$ 的时候，如果不是每个数字在 $[l_1,r_1]\bigcup[l_2,r_2]$ 中均出现偶数次，就不可能全消，直接退出，可以加快计算。

实测 $n=50$ 时在最极限情况下（$50$ 个 $1$） 验题人的程序（在验题人本机，开 O2，其余配置省略）运行约 0.3 秒（出题人的运行了约 0.9 秒，原因是出题人用 dfs 写的 dp）。总之能够通过本题。